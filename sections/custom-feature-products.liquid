{{- 'custom-feature-products.css' | asset_url | stylesheet_tag -}}
<script src="{{ 'custom-feature-products.js' | asset_url }}" defer="defer"></script>

<!-- Dynamic CSS Variables from Settings -->
<style>
  :root {
    /* Desktop Spacing */
    --fp-desktop-padding-x: {{ section.settings.desktop_padding_x }}px;
    --fp-desktop-padding-y: {{ section.settings.desktop_padding_y }}px;
    --fp-desktop-gap: {{ section.settings.desktop_gap }}px;
    --fp-desktop-columns: {{ section.settings.desktop_columns }};
    
    /* Mobile Spacing */
    --fp-mobile-padding-x: {{ section.settings.mobile_padding_x }}px;
    --fp-mobile-padding-y: {{ section.settings.mobile_padding_y }}px;
    --fp-mobile-gap: {{ section.settings.mobile_gap }}px;
    --fp-mobile-columns: {{ section.settings.mobile_columns }};
    
    /* Colors */
    --fp-bg-color: {{ section.settings.background_color }};
    --fp-heading-color: {{ section.settings.heading_color }};
    --fp-icon-bg-color: {{ section.settings.icon_bg_color }};
    --fp-icon-color: {{ section.settings.icon_color }};
  }
</style>

<section class="custom-feature-products" data-section-id="{{ section.id }}">
  <div class="custom-feature-products__container">
    
    <!-- Section Header -->
    {% if section.settings.heading != blank %}
      <header class="custom-feature-products__header" style="text-align: {{ section.settings.heading_alignment }};">
        <h2 class="custom-feature-products__heading">
          {{ section.settings.heading }}
        </h2>
        {% if section.settings.subheading != blank %}
          <p class="custom-feature-products__subheading">
            {{ section.settings.subheading }}
          </p>
        {% endif %}
      </header>
    {% endif %}

    <!-- Products Grid -->
    <div class="custom-feature-products__grid">
      {% for block in section.blocks %}
        {% if block.type == 'product_item' %}
          <div class="custom-feature-products__item" {{ block.shopify_attributes }}>
            {% if block.settings.product != blank %}
              {% assign product = block.settings.product %}
              <div class="custom-feature-products__link">
                <div class="custom-feature-products__image-wrapper">
                  {% if block.settings.custom_image != blank %}
                    <img 
                      src="{{ block.settings.custom_image | image_url: width: 800 }}" 
                      alt="{{ block.settings.custom_image.alt | default: product.title }}"
                      class="custom-feature-products__image"
                      loading="lazy"
                      width="400"
                      height="500"
                    >
                  {% elsif product.featured_image != blank %}
                    <img 
                      src="{{ product.featured_image | image_url: width: 800 }}" 
                      alt="{{ product.featured_image.alt | default: product.title }}"
                      class="custom-feature-products__image"
                      loading="lazy"
                      width="400"
                      height="500"
                    >
                  {% else %}
                    {{ 'product-1' | placeholder_svg_tag: 'custom-feature-products__placeholder' }}
                  {% endif %}
                  
                  <!-- Plus Icon Button - Opens Modal -->
                  <button 
                    class="custom-feature-products__icon-btn"
                    type="button"
                    style="
                      top: {{ block.settings.icon_position_y }}%;
                      left: {{ block.settings.icon_position_x }}%;
                    "
                    aria-label="Quick view {{ product.title }}"
                    data-product-handle="{{ product.handle }}"
                    data-product-id="{{ product.id }}"
                    data-product-url="{{ product.url }}"
                    data-product-title="{{ product.title }}"
                    data-product-price="{{ product.price | money }}"
                    data-product-description="{{ product.description | strip_html | truncate: 150 }}"
                    data-product-image="{{ product.featured_image | image_url: width: 400 }}"
                    data-product-variants='{{ product.variants | json }}'
                    data-product-options='{{ product.options_with_values | json }}'
                  >
                    <span class="custom-feature-products__icon-plus">+</span>
                  </button>
                </div>
              </div>
            {% else %}
              <!-- Placeholder when no product selected -->
              <div class="custom-feature-products__link">
                <div class="custom-feature-products__image-wrapper">
                  {{ 'product-1' | placeholder_svg_tag: 'custom-feature-products__placeholder' }}
                  <button 
                    class="custom-feature-products__icon-btn"
                    type="button"
                    style="
                      top: {{ block.settings.icon_position_y }}%;
                      left: {{ block.settings.icon_position_x }}%;
                    "
                    aria-label="View product"
                    disabled
                  >
                    <span class="custom-feature-products__icon-plus">+</span>
                  </button>
                </div>
              </div>
            {% endif %}
          </div>
        {% endif %}
      {% endfor %}
    </div>

  </div>
</section>

<!-- Quick View Modal -->
<div class="fp-modal" id="fp-quick-view-modal" aria-hidden="true">
  <div class="fp-modal__overlay"></div>
  <div class="fp-modal__container">
    <button class="fp-modal__close" type="button" aria-label="Close modal">
      <span>×</span>
    </button>
    
    <div class="fp-modal__content">
      <!-- Product Header: Image + Info Side by Side -->
      <div class="fp-modal__product-header">
        <div class="fp-modal__image-wrapper">
          <img src="" alt="" class="fp-modal__image" id="fp-modal-image">
        </div>
        
        <div class="fp-modal__info">
          <h3 class="fp-modal__title" id="fp-modal-title"></h3>
          <p class="fp-modal__price" id="fp-modal-price"></p>
          <p class="fp-modal__description" id="fp-modal-description"></p>
        </div>
      </div>
      
      <!-- Variant Options Container -->
      <div class="fp-modal__options" id="fp-modal-options">
        <!-- Options will be dynamically inserted here -->
      </div>
      
      <!-- Add to Cart Form -->
      <form class="fp-modal__form" id="fp-modal-form">
        <input type="hidden" name="id" id="fp-modal-variant-id" value="">
        <input type="hidden" name="quantity" value="1">
        
        <button type="submit" class="fp-modal__add-btn" id="fp-modal-add-btn">
          <span class="fp-modal__add-btn-text">ADD TO CART</span>
          <span class="fp-modal__add-btn-arrow">⟶</span>
          <span class="fp-modal__spinner hidden">
            <svg class="spinner" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2" stroke-dasharray="31.4" stroke-dashoffset="31.4">
                <animate attributeName="stroke-dashoffset" values="31.4;0" dur="1s" repeatCount="indefinite"/>
              </circle>
            </svg>
          </span>
        </button>
        
        <div class="fp-modal__error hidden" id="fp-modal-error"></div>
      </form>
    </div>
  </div>
</div>

{% schema %}
{
  "name": "Feature Products Grid",
  "class": "section-custom-feature-products",
  "tag": "section",
  "settings": [
    {
      "type": "header",
      "content": "Section Header"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Tisso vison in the wild"
    },
    {
      "type": "text",
      "id": "subheading",
      "label": "Subheading",
      "default": "Tisso Vision in the wild"
    },
    {
      "type": "select",
      "id": "heading_alignment",
      "label": "Heading Alignment",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" }
      ],
      "default": "left"
    },
    {
      "type": "color",
      "id": "heading_color",
      "label": "Heading Color",
      "default": "#1a1a1a"
    },
    {
      "type": "header",
      "content": "Grid Settings"
    },
    {
      "type": "range",
      "id": "desktop_columns",
      "min": 2,
      "max": 6,
      "step": 1,
      "label": "Desktop Columns",
      "default": 3
    },
    {
      "type": "range",
      "id": "mobile_columns",
      "min": 1,
      "max": 3,
      "step": 1,
      "label": "Mobile Columns",
      "default": 2
    },
    {
      "type": "header",
      "content": "Desktop Spacing"
    },
    {
      "type": "range",
      "id": "desktop_padding_x",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "label": "Horizontal Padding",
      "default": 40
    },
    {
      "type": "range",
      "id": "desktop_padding_y",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "label": "Vertical Padding",
      "default": 40
    },
    {
      "type": "range",
      "id": "desktop_gap",
      "min": 0,
      "max": 40,
      "step": 2,
      "unit": "px",
      "label": "Grid Gap",
      "default": 16
    },
    {
      "type": "header",
      "content": "Mobile Spacing"
    },
    {
      "type": "range",
      "id": "mobile_padding_x",
      "min": 0,
      "max": 40,
      "step": 2,
      "unit": "px",
      "label": "Horizontal Padding",
      "default": 16
    },
    {
      "type": "range",
      "id": "mobile_padding_y",
      "min": 0,
      "max": 60,
      "step": 2,
      "unit": "px",
      "label": "Vertical Padding",
      "default": 24
    },
    {
      "type": "range",
      "id": "mobile_gap",
      "min": 0,
      "max": 24,
      "step": 2,
      "unit": "px",
      "label": "Grid Gap",
      "default": 8
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Section Background",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "icon_bg_color",
      "label": "Plus Icon Background",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "icon_color",
      "label": "Plus Icon Color",
      "default": "#1a1a1a"
    }
  ],
  "blocks": [
    {
      "type": "product_item",
      "name": "Product",
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Select Product"
        },
        {
          "type": "image_picker",
          "id": "custom_image",
          "label": "Custom Image (Optional)",
          "info": "Override the product's featured image"
        },
        {
          "type": "header",
          "content": "Plus Icon Position"
        },
        {
          "type": "range",
          "id": "icon_position_x",
          "min": 5,
          "max": 95,
          "step": 1,
          "unit": "%",
          "label": "Horizontal Position (Left to Right)",
          "default": 50
        },
        {
          "type": "range",
          "id": "icon_position_y",
          "min": 5,
          "max": 95,
          "step": 1,
          "unit": "%",
          "label": "Vertical Position (Top to Bottom)",
          "default": 50
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Feature Products Grid",
      "blocks": [
        { "type": "product_item" },
        { "type": "product_item" },
        { "type": "product_item" },
        { "type": "product_item" },
        { "type": "product_item" },
        { "type": "product_item" }
      ]
    }
  ],
  "enabled_on": {
    "templates": ["*"]
  }
}
{% endschema %}